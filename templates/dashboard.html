<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ config.COLLEGE_NAME }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard_clean.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <img src="{{ url_for('static', filename='uploads/logo.png') }}" alt="GGI Logo" class="logo" onerror="this.style.display='none'">
                    <div class="header-text">
                        <h1>{{ config.COLLEGE_NAME }}</h1>
                        <p>Academic Excellence Since 1995</p>
                    </div>
                </div>
                
                <!-- Mobile Menu Button -->
                <button class="mobile-menu-button" type="button" aria-label="Toggle navigation">
                    <div class="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
                
                <nav class="nav-menu">
                    <a href="{{ url_for('index') }}" class="nav-link">Generate</a>
                    <a href="{{ url_for('history') }}" class="nav-link">History</a>
                    <a href="{{ url_for('dashboard') }}" class="nav-link active">Dashboard</a>
                    <a href="{{ url_for('logout') }}" class="nav-link logout">Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="page-header text-center">
            <h2>Analytics Dashboard</h2>
            <p>Comprehensive overview of academic performance and statistics</p>
        </div>

        <div class="form-container">
            <!-- Statistics Overview Section -->
            <section class="form-section">
                <h3>üìä Performance Overview</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h3>{{ total_students }}</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <h3>{{ passed_students }}</h3>
                            <p>Students Passed</p>
                        </div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-info">
                            <h3>{{ failed_students }}</h3>
                            <p>Students Failed</p>
                        </div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-info">
                            <h3>{{ avg_percentage }}%</h3>
                            <p>Average Percentage</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="form-section">
                <h3>üìà Performance Analytics</h3>
                <div class="charts-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Pass/Fail Statistics</h3>
                        </div>
                        <div class="chart-content">
                            <canvas id="passFailChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Branch-wise Performance</h3>
                        </div>
                        <div class="chart-content">
                            <canvas id="branchChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Top Performers Section -->
            <section class="form-section">
                <div class="section-header">
                    <h3>üèÜ Top Performers</h3>
                    <div class="section-actions">
                        <a href="{{ url_for('export_data') }}" class="btn-primary">üì§ Export Data</a>
                    </div>
                </div>
                
                {% if top_performers %}
                <div class="performers-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Student Name</th>
                                <th>Roll Number</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for performer in top_performers %}
                            <tr>
                                <td>
                                    {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}
                                </td>
                                <td>{{ performer.name }}</td>
                                <td>{{ performer.roll_no }}</td>
                                <td>{{ performer.percentage }}%</td>
                                <td class="grade-{{ performer.grade.lower().replace('+', 'plus') }}">{{ performer.grade }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-data">
                    <p>No performance data available yet.</p>
                    <div class="btn-container">
                        <a href="{{ url_for('index') }}" class="btn-primary">üìù Generate First Marksheet</a>
                    </div>
                </div>
                {% endif %}
            </section>

            <!-- Branch Statistics Section -->
            {% if branch_stats %}
            <section class="form-section">
                <h3>üèõÔ∏è Branch-wise Statistics</h3>
                <div class="branch-grid">
                    {% for branch in branch_stats %}
                    <div class="branch-card">
                        <h4>{{ branch.branch }}</h4>
                        <div class="branch-info">
                            <p><strong>Students:</strong> {{ branch.count }}</p>
                            <p><strong>Avg Percentage:</strong> {{ "%.2f"|format(branch.avg_perc) }}%</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 {{ config.COLLEGE_NAME }}. All rights reserved.</p>
            <p>Dashboard Analytics v1.0</p>
        </div>
    </footer>

    <!-- Chart Data passed from server -->
    <script id="chart-data" type="application/json">
        {
            "passedStudents": {{ passed_students|default(0) }},
            "failedStudents": {{ failed_students|default(0) }},
            "branchLabels": [
                {% if branch_stats %}
                    {% for branch in branch_stats %}
                        "{{ branch.branch[:15] }}..."{% if not loop.last %},{% endif %}
                    {% endfor %}
                {% endif %}
            ],
            "branchData": [
                {% if branch_stats %}
                    {% for branch in branch_stats %}
                        {{ "%.2f"|format(branch.avg_perc|default(0)) }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                {% endif %}
            ]
        }
    </script>

    <script>
        // Parse chart data from server
        const chartDataElement = document.getElementById('chart-data');
        const chartData = JSON.parse(chartDataElement.textContent);

        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Pass/Fail Chart
                const passFailCtx = document.getElementById('passFailChart');
                if (passFailCtx && typeof Chart !== 'undefined') {
                    const totalStudents = chartData.passedStudents + chartData.failedStudents;
                    
                    if (totalStudents > 0) {
                        new Chart(passFailCtx.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: ['Passed', 'Failed'],
                                datasets: [{
                                    data: [chartData.passedStudents, chartData.failedStudents],
                                    backgroundColor: ['#4CAF50', '#f44336'],
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed;
                                                const percentage = ((value / totalStudents) * 100).toFixed(1);
                                                return label + ': ' + value + ' (' + percentage + '%)';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        // Show no data message
                        const container = passFailCtx.parentElement;
                        container.innerHTML = '<div class="no-data-message">No student data available</div>';
                    }
                }

                // Branch Performance Chart
                const branchCtx = document.getElementById('branchChart');
                if (branchCtx && typeof Chart !== 'undefined' && chartData.branchLabels.length > 0) {
                    new Chart(branchCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: chartData.branchLabels,
                            datasets: [{
                                label: 'Average Percentage',
                                data: chartData.branchData,
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4CAF50', 
                                    '#FF9800', '#9C27B0', '#00BCD4', '#795548'
                                ],
                                borderWidth: 1,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'Average: ' + context.parsed.y.toFixed(1) + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else if (branchCtx) {
                    // Show no data message for branch chart
                    const container = branchCtx.parentElement;
                    container.innerHTML = '<div class="no-data-message">No branch data available</div>';
                }
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        });

        // Handle Chart.js loading error
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('Chart')) {
                console.warn('Chart.js failed to load. Charts will not be displayed.');
                const chartContainers = document.querySelectorAll('.chart-content');
                chartContainers.forEach(container => {
                    container.innerHTML = '<div style="text-align: center; padding: 50px; color: #f44336;">Charts unavailable - Chart.js failed to load</div>';
                });
            }
        });

        // Initialize Analytics Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize analytics if functions are available
            if (typeof initializeAnalytics === 'function') {
                initializeAnalytics();
            }
        });
    </script>
    
    <!-- Analytics Script -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
